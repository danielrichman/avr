/*
    The DomEX22 code below originates from the fl-digi program;
    it has since been modified by CUSF and then myself. Therefore,

    fldigi/src/dominoex/dominoex.cxx & fldigi/include/dominoex.h
       Copyright (C) 2001, 2002, 2003
                  Tomi Manninen (oh2bns@sral.fi)
       Copyright (C) 2006
                  Hamish Moffatt (hamish@debian.org)
       Copyright (C) 2006, 2008-2009
                  David Freese (w1hkj@w1hkj.com)

       based on code in gmfsk

    fldigi/src/dominoex/dominovar.cxx
       Copyright (C) 2001, 2002, 2003
                  Tomi Manninen (oh2bns@sral.fi)

    Copyright (C) 2010 CU Spaceflight
    Copyright (C) 2010 Daniel Richman

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    For a full copy of the GNU General Public License, 
    see <http://www.gnu.org/licenses/>.
*/

#include <string.h>
#include <stdint.h>
#include <avr/io.h>
#include <util/delay.h>

#define NUM_TONES 18
#define BASE 2741
#define TONE_SHIFT 36
#define DELAY 1484

/* This is the primary alphabet only;
 * if you want the secondary alphabet, go fish */
static uint16_t varicode[] = {
  0x09f1, 0x0af1, 0x0bf1, 0x0cf1, 0x0df1, 0x0ef1, 0x0ff1, 0x0882, 0x00c2, 
  0x0982, 0x0a82, 0x0b82, 0x0c82, 0x00d2, 0x0d82, 0x0e82, 0x0f82, 0x0892, 
  0x0992, 0x0a92, 0x0b92, 0x0c92, 0x0d92, 0x0e92, 0x0f92, 0x08a2, 0x09a2, 
  0x0aa2, 0x0ba2, 0x0ca2, 0x0da2, 0x0ea2, 0x0000, 0x00b7, 0x0e80, 0x0ba0, 
  0x0a90, 0x0990, 0x0f80, 0x00a7, 0x0c80, 0x0b80, 0x0d90, 0x0880, 0x00b2, 
  0x00e7, 0x00d7, 0x0980, 0x00f3, 0x00a4, 0x00f4, 0x0095, 0x0086, 0x00c5, 
  0x00e5, 0x00c6, 0x00b6, 0x00e6, 0x0a80, 0x0d80, 0x08a0, 0x00f7, 0x0f90, 
  0x00c7, 0x0890, 0x0093, 0x00e4, 0x00c3, 0x00e3, 0x0083, 0x00c4, 0x0085, 
  0x00a5, 0x00a3, 0x0087, 0x00a6, 0x00b4, 0x0084, 0x00d4, 0x00b3, 0x0094, 
  0x00f6, 0x00d3, 0x00f2, 0x00e2, 0x00b5, 0x00d6, 0x00d5, 0x00f5, 0x0096, 
  0x0097, 0x0ea0, 0x09a0, 0x0fa0, 0x0aa0, 0x0c90, 0x0b90, 0x0004, 0x00b1, 
  0x00c0, 0x00b0, 0x0001, 0x00f0, 0x0091, 0x00a0, 0x0005, 0x00a2, 0x00e1, 
  0x0090, 0x00e0, 0x0006, 0x0003, 0x0081, 0x0082, 0x0007, 0x0080, 0x0002, 
  0x00d0, 0x00d1, 0x00c1, 0x00f1, 0x00a1, 0x0092, 0x0ca0, 0x0e90, 0x0ca0, 
  0x08b0, 0x0fa2, 0x08b2, 0x09b2, 0x0ab2, 0x0bb2, 0x0cb2, 0x0db2, 0x0eb2, 
  0x0fb2, 0x08c2, 0x09c2, 0x0ac2, 0x0bc2, 0x0cc2, 0x0dc2, 0x0ec2, 0x0fc2, 
  0x08d2, 0x09d2, 0x0ad2, 0x0bd2, 0x0cd2, 0x0dd2, 0x0ed2, 0x0fd2, 0x08e2, 
  0x09e2, 0x0ae2, 0x0be2, 0x0ce2, 0x0de2, 0x0ee2, 0x0fe2, 0x09b0, 0x0ab0, 
  0x0bb0, 0x0cb0, 0x0db0, 0x0eb0, 0x0fb0, 0x08c0, 0x09c0, 0x0ac0, 0x0bc0, 
  0x0cc0, 0x0dc0, 0x0ec0, 0x0fc0, 0x08d0, 0x09d0, 0x0ad0, 0x0bd0, 0x0cd0, 
  0x0dd0, 0x0ed0, 0x0fd0, 0x08e0, 0x09e0, 0x0ae0, 0x0be0, 0x0ce0, 0x0de0, 
  0x0ee0, 0x0fe0, 0x08f0, 0x09f0, 0x0af0, 0x0bf0, 0x0cf0, 0x0df0, 0x0ef0, 
  0x0ff0, 0x0881, 0x0981, 0x0a81, 0x0b81, 0x0c81, 0x0d81, 0x0e81, 0x0f81, 
  0x0891, 0x0991, 0x0a91, 0x0b91, 0x0c91, 0x0d91, 0x0e91, 0x0f91, 0x08a1, 
  0x09a1, 0x0aa1, 0x0ba1, 0x0ca1, 0x0da1, 0x0ea1, 0x0fa1, 0x08b1, 0x09b1, 
  0x0ab1, 0x0bb1, 0x0cb1, 0x0db1, 0x0eb1, 0x0fb1, 0x08c1, 0x09c1, 0x0ac1, 
  0x0bc1, 0x0cc1, 0x0dc1, 0x0ec1, 0x0fc1, 0x08d1, 0x09d1, 0x0ad1, 0x0bd1, 
  0x0cd1, 0x0dd1, 0x0ed1, 0x0fd1, 0x08e1, 0x09e1, 0x0ae1, 0x0be1, 0x0ce1, 
  0x0de1, 0x0ee1, 0x0fe1, 0x08f1, 0x09f6 };

static void dominoex_sendtone(uint8_t tone)
{
  while (!(TCD0.INTFLAGS & TC0_OVFIF_bm));
  TCD0.INTFLAGS = TC0_OVFIF_bm;

  DACA.CH0DATA = BASE - (tone * TONE_SHIFT);
}

static void dominoex_sendsymbol(uint8_t sym)
{
  uint8_t tone;  
  static uint8_t txprevtone = 0;

  tone = (txprevtone + 2 + sym) % NUM_TONES;
  txprevtone = tone;
  dominoex_sendtone(tone);
}

void transmit_dominoex_character(uint8_t c)
{
  uint16_t data = varicode[c];

  do
  {
    dominoex_sendsymbol(data & 0xF);
    data >>= 4;
  }
  while (data & 0x8);
}

char *str = "Greetings, human.\n";

int main(void)
{
  uint8_t i;

  DACA.CTRLA = DAC_CH0EN_bm | DAC_ENABLE_bm;
  DACA.CTRLC = DAC_REFSEL_INT1V_gc;
  DACA.CH0DATA = 0x00;

  TCD0.PER = DELAY;
  TCD0.CTRLA = TC_CLKSEL_DIV64_gc;

  for (;;)
  {
    for (i = 0; i < strlen(str); i++)
    {
      transmit_dominoex_character(str[i]);
    }
  }
}
